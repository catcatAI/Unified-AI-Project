<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>åæ¨™è½‰æ›è¨ºæ–·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e0e0e0;
            font-family: 'Segoe UI', Arial, sans-serif;
            min-height: 100vh;
            padding: 20px;
        }

        h1 {
            color: #e94560;
            margin-bottom: 20px;
        }

        .container {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .test-area {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .canvas-wrapper {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(1);
            width: 400px;
            height: 500px;
            z-index: 15;
            display: block;
            pointer-events: auto;
            border: 2px dashed rgba(233, 69, 96, 0.5);
            transition: transform 0.3s ease;
        }

        #fallback-canvas {
            width: 100%;
            height: 100%;
            background: rgba(233, 69, 96, 0.2);
            border-radius: 10px;
            cursor: crosshair;
        }

        .info-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        button {
            background: #e94560;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background: #ff6b6b;
        }

        .log {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }

        .touch-zone {
            position: absolute;
            border: 2px solid rgba(0, 255, 0, 0.8);
            background: rgba(0, 255, 0, 0.1);
            border-radius: 5px;
            pointer-events: none;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .grid-cell {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            text-align: center;
            border-radius: 5px;
            font-size: 12px;
        }

        .grid-cell.detected {
            background: rgba(0, 255, 0, 0.3);
        }

        .formula {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
        }

        .formula-title {
            color: #e94560;
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>ğŸ¯ ç«‹ç¹ªåæ¨™è½‰æ›è¨ºæ–·</h1>

    <div class="controls">
        <span>ç¸®æ”¾: </span>
        <button onclick="updateScale(-0.1)">-</button>
        <span id="scale-display">1.0x</span>
        <button onclick="updateScale(0.1)">+</button>
        <button onclick="testAllCells()">æ¸¬è©¦æ‰€æœ‰ç¶²æ ¼</button>
        <button onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
    </div>

    <div class="container">
        <div class="test-area">
            <h3>æ¸¬è©¦å€åŸŸ</h3>
            <div class="canvas-wrapper" id="test-wrapper">
                <canvas id="fallback-canvas" width="400" height="500"></canvas>
            </div>
        </div>

        <div class="test-area" style="flex: 1;">
            <h3>è½‰æ›å…¬å¼</h3>
            <div class="formula">
                <div class="formula-title">1. é»æ“Š â†’ Wrapper åæ¨™</div>
                wrapperX = clientX - rect.left
                wrapperY = clientY - rect.top
            </div>
            <div class="formula">
                <div class="formula-title">2. Wrapper â†’ Canvas å…§éƒ¨åæ¨™</div>
                totalScale = canvasWidth / rect.width  // rect åŒ…å« CSS transform
                canvasX = wrapperX * totalScale
                canvasY = wrapperY * totalScale
            </div>
            <div class="formula">
                <div class="formula-title">3. Canvas â†’ åœ–ç‰‡åæ¨™</div>
                imgScale = 0.4  // ctx.scale(0.4)
                imgX = (canvasX - canvasWidth/2) / imgScale + imgWidth/2
                imgY = (canvasY - canvasHeight/2) / imgScale + imgHeight/2
            </div>

            <h3>ç¶²æ ¼æ¸¬è©¦ (4x4)</h3>
            <div class="test-grid" id="test-grid"></div>
        </div>
    </div>

    <div class="info-panel">
        <h3>è¨ºæ–·æ—¥èªŒ</h3>
        <div class="log" id="log"></div>
    </div>

    <div class="info-panel">
        <h3>ç•¶å‰ç‹€æ…‹</h3>
        <p>CSS Transform: <span id="css-transform"></span></p>
        <p>JS FallbackScale: <span id="js-scale"></span></p>
        <p>Wrapper rect: <span id="rect-info"></span></p>
        <p>Canvas size: <span id="canvas-info"></span></p>
    </div>

    <script>
        const wrapper = document.getElementById('test-wrapper');
        const canvas = document.getElementById('fallback-canvas');
        const ctx = canvas.getContext('2d');
        const log = document.getElementById('log');
        let fallbackScale = 1.0;
        const characterImage = {
            width: 768,
            height: 1024
        };

        function log(msg) {
            const line = document.createElement('div');
            line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            log.appendChild(line);
            log.scrollTop = log.scrollHeight;
        }

        function updateStatus() {
            const style = window.getComputedStyle(wrapper);
            document.getElementById('css-transform').textContent = style.transform;
            document.getElementById('js-scale').textContent = fallbackScale.toFixed(2);
            const rect = wrapper.getBoundingClientRect();
            document.getElementById('rect-info').textContent =
                `rect.width=${rect.width.toFixed(1)}, rect.height=${rect.height.toFixed(1)}`;
            document.getElementById('canvas-info').textContent =
                `canvas.width=${canvas.width}, canvas.height=${canvas.height}`;
        }

        function updateScale(delta) {
            fallbackScale = Math.max(0.5, Math.min(2.0, fallbackScale + delta));
            wrapper.style.transform = `translate(-50%, -50%) scale(${fallbackScale})`;
            document.getElementById('scale-display').textContent = fallbackScale.toFixed(1) + 'x';
            log(`ç¸®æ”¾æ›´æ–°: ${fallbackScale.toFixed(2)}`);
            log(`CSS Transform: ${wrapper.style.transform}`);
            updateStatus();
        }

        function clearLog() {
            log.innerHTML = '';
        }

        // ç¹ªè£½æ¸¬è©¦ç¶²æ ¼
        function drawTestGrid() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ç¹ªè£½ 4x4 ç¶²æ ¼
            const cellW = canvas.width / 4;
            const cellH = canvas.height / 4;

            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 1;

            for (let i = 1; i < 4; i++) {
                ctx.beginPath();
                ctx.moveTo(i * cellW, 0);
                ctx.lineTo(i * cellW, canvas.height);
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(0, i * cellH);
                ctx.lineTo(canvas.width, i * cellH);
                ctx.stroke();
            }

            // ç¹ªè£½æ¸¬è©¦ç¶²æ ¼ (4x4 = 16 å€‹å€åŸŸ)
            const testGrid = document.getElementById('test-grid');
            testGrid.innerHTML = '';

            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 4; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    cell.textContent = `(${col},${row})`;
                    testGrid.appendChild(cell);
                }
            }

            // ç¹ªè£½åœ“å½¢æ¸¬è©¦é»
            const scale = 0.4;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;

            ctx.fillStyle = '#e94560';
            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 4; col++) {
                    const imgX = (col * cellW - centerX) / scale + characterImage.width / 2;
                    const imgY = (row * cellH - centerY) / scale + characterImage.height / 2;

                    const canvasX = col * cellW + cellW / 2;
                    const canvasY = row * cellH + cellH / 2;

                    ctx.beginPath();
                    ctx.arc(canvasX, canvasY, 5, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }

        // è¨ˆç®—ç¶²æ ¼å€åŸŸ
        function getGridCell(imgX, imgY) {
            const scale = 0.4;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const cellW = canvas.width / 4;
            const cellH = canvas.height / 4;

            const canvasX = (imgX - characterImage.width / 2) * scale + centerX;
            const canvasY = (imgY - characterImage.height / 2) * scale + centerY;

            const col = Math.floor(canvasX / cellW);
            const row = Math.floor(canvasY / cellH);

            return { row: Math.max(0, Math.min(3, row)), col: Math.max(0, Math.min(3, col)) };
        }

        // æ¸¬è©¦æ‰€æœ‰ç¶²æ ¼
        function testAllCells() {
            const scale = 0.4;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const cellW = canvas.width / 4;
            const cellH = canvas.height / 4;

            log('\n========== æ¸¬è©¦æ‰€æœ‰ç¶²æ ¼å€åŸŸ ==========');

            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 4; col++) {
                    // è¨ˆç®—åœ–ç‰‡åæ¨™ï¼ˆæ¯å€‹å€åŸŸçš„ä¸­å¿ƒï¼‰
                    const imgX = (col * cellW + cellW / 2 - centerX) / scale + characterImage.width / 2;
                    const imgY = (row * cellH + cellH / 2 - centerY) / scale + characterImage.height / 2;

                    // åå‘è¨ˆç®— Canvas åæ¨™
                    const canvasX = col * cellW + cellW / 2;
                    const canvasY = row * cellH + cellH / 2;

                    // åå‘è¨ˆç®— Wrapper åæ¨™
                    const rect = wrapper.getBoundingClientRect();
                    const totalScale = canvas.width / rect.width;
                    const wrapperX = canvasX / totalScale;
                    const wrapperY = canvasY / totalScale;

                    log(`å€åŸŸ (${col},${row}):`);
                    log(`  åœ–ç‰‡åæ¨™: (${imgX.toFixed(1)}, ${imgY.toFixed(1)})`);
                    log(`  Canvas åæ¨™: (${canvasX.toFixed(1)}, ${canvasY.toFixed(1)})`);
                    log(`  Wrapper åæ¨™: (${wrapperX.toFixed(1)}, ${wrapperY.toFixed(1)})`);
                    log(`  rect.width=${rect.width.toFixed(1)}, totalScale=${totalScale.toFixed(4)}`);
                }
            }

            log('\n========== é»æ“Šæ¸¬è©¦ ==========');
        }

        // é»æ“Šäº‹ä»¶è™•ç†
        wrapper.addEventListener('click', (event) => {
            log('\n===== é»æ“Šäº‹ä»¶ =====');
            log(`fallbackScale: ${fallbackScale}`);

            const rect = wrapper.getBoundingClientRect();
            log(`rect.width: ${rect.width}, rect.height: ${rect.height}`);

            const wrapperX = event.clientX - rect.left;
            const wrapperY = event.clientY - rect.top;
            log(`wrapper åæ¨™: (${wrapperX.toFixed(1)}, ${wrapperY.toFixed(1)})`);

            // è¨ˆç®— totalScaleï¼ˆé€™æ˜¯é—œéµï¼ï¼‰
            const totalScale = canvas.width / rect.width;
            log(`totalScale (canvas/rect): ${totalScale.toFixed(4)}`);

            // Canvas å…§éƒ¨åæ¨™
            const canvasX = wrapperX * totalScale;
            const canvasY = wrapperY * totalScale;
            log(`Canvas å…§éƒ¨åæ¨™: (${canvasX.toFixed(1)}, ${canvasY.toFixed(1)})`);

            // åœ–ç‰‡åæ¨™
            const scale = 0.4;
            const imgX = (canvasX - canvas.width / 2) / scale + characterImage.width / 2;
            const imgY = (canvasY - canvas.height / 2) / scale + characterImage.height / 2;
            log(`åœ–ç‰‡åæ¨™: (${imgX.toFixed(1)}, ${imgY.toFixed(1)})`);

            // æª¢æ¸¬ç¶²æ ¼å€åŸŸ
            const cell = getGridCell(imgX, imgY);
            log(`æª¢æ¸¬åˆ°çš„å€åŸŸ: (${cell.col}, ${cell.row})`);

            // é«˜äº®é¸ä¸­å€åŸŸ
            document.querySelectorAll('.grid-cell').forEach(c => c.classList.remove('detected'));
            const targetCell = document.querySelector(`.grid-cell[data-row="${cell.row}"][data-col="${cell.col}"]`);
            if (targetCell) {
                targetCell.classList.add('detected');
                log(`é«˜äº®å€åŸŸ: (${cell.col}, ${cell.row})`);
            }

            // ç¹ªè£½é»æ“Šä½ç½®
            ctx.fillStyle = 'rgba(0, 255, 0, 0.8)';
            ctx.beginPath();
            ctx.arc(canvasX, canvasY, 8, 0, Math.PI * 2);
            ctx.fill();

            updateStatus();
        });

        // åˆå§‹åŒ–
        drawTestGrid();
        updateStatus();
        log('è¨ºæ–·é é¢å·²è¼‰å…¥ï¼Œé»æ“Šæ¸¬è©¦å€åŸŸæŸ¥çœ‹åæ¨™è½‰æ›');
        log(`åˆå§‹ fallbackScale: ${fallbackScale}`);
    </script>
</body>
</html>