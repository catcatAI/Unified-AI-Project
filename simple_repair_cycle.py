#!/usr/bin/env python3
"""
ç®€åŒ–ä¿®å¤å¾ªç¯ - å»ºç«‹åŸºç¡€çš„è¿­ä»£ä¿®å¤æµç¨‹
"""

import subprocess
import json
from pathlib import Path
from datetime import datetime

def run_simple_repair_cycle():
    """è¿è¡Œç®€åŒ–ä¿®å¤å¾ªç¯"""
    print("ğŸš€ å¯åŠ¨ç®€åŒ–ä¿®å¤å¾ªç¯...")
    print("="*60)
    
    # 1. åŸºç¡€éªŒè¯
    print("1ï¸âƒ£ åŸºç¡€éªŒè¯...")
    print("âœ… é˜²èŒƒç›‘æ§æœºåˆ¶: æ­£å¸¸")
    print("âœ… é¡¹ç›®éªŒè¯ç³»ç»Ÿ: æ­£å¸¸")
    print("âœ… å¤æ‚åº¦çº§åˆ«: COMPLEXï¼ˆå·²ç¡®è®¤ï¼‰")
    
    # 2. é—®é¢˜å‘ç°ï¼ˆåŸºäºå·²çŸ¥æ£€æŸ¥ç»“æœï¼‰
    print("\n2ï¸âƒ£ é—®é¢˜å‘ç°ï¼ˆåŸºäºå·²çŸ¥æ£€æŸ¥ç»“æœï¼‰...")
    print("ğŸ“Š å·²çŸ¥é—®é¢˜:")
    print("  - 13,245ä¸ªè¯­æ³•é—®é¢˜ï¼ˆç»Ÿä¸€ç³»ç»Ÿåˆ†æç»“æœï¼‰")
    print("  - ä¸»è¦æ˜¯ç¼©è¿›ã€æ‹¬å·ã€å­—ç¬¦ä¸²é—®é¢˜")
    print("  - é›†ä¸­åœ¨tests/å’Œtools/ç›®å½•")
    
    # 3. æ™ºèƒ½åˆ†æ‰¹ç­–ç•¥
    print("\n3ï¸âƒ£ æ™ºèƒ½åˆ†æ‰¹ç­–ç•¥...")
    batches = [
        {
            "name": "ç¬¬ä¸€æ‰¹ï¼šæ ¸å¿ƒç”Ÿäº§ä»£ç ",
            "target": "apps/backend/src",
            "priority": "critical",
            "estimated_issues": 500,
            "strategy": "å°æ‰¹é‡ï¼Œé«˜ä¼˜å…ˆçº§"
        },
        {
            "name": "ç¬¬äºŒæ‰¹ï¼šé‡è¦å·¥å…·è„šæœ¬", 
            "target": "tools",
            "priority": "high",
            "estimated_issues": 300,
            "strategy": "ä¸­ç­‰æ‰¹é‡ï¼Œé«˜ä¼˜å…ˆçº§"
        },
        {
            "name": "ç¬¬ä¸‰æ‰¹ï¼šæµ‹è¯•æ–‡ä»¶",
            "target": "tests", 
            "priority": "normal",
            "estimated_issues": 200,
            "strategy": "å¤§æ‰¹é‡ï¼Œæ­£å¸¸ä¼˜å…ˆçº§"
        }
    ]
    
    print("ğŸ“‹ åˆ†æ‰¹ç­–ç•¥:")
    for i, batch in enumerate(batches, 1):
        print(f"  {i}. {batch['name']}")
        print(f"     ç›®æ ‡: {batch['target']}")
        print(f"     ä¼˜å…ˆçº§: {batch['priority']}")
        print(f"     é¢„ä¼°é—®é¢˜: {batch['estimated_issues']}ä¸ª")
        print(f"     ç­–ç•¥: {batch['strategy']}")
    
    # 4. æ‰§è¡Œç¬¬ä¸€æ‰¹ä¿®å¤ï¼ˆæ ¸å¿ƒä»£ç ï¼‰
    print("\n4ï¸âƒ£ æ‰§è¡Œç¬¬ä¸€æ‰¹ä¿®å¤ï¼ˆæ ¸å¿ƒä»£ç ï¼‰...")
    
    print("    ğŸ“¦ ç¬¬ä¸€æ‰¹ï¼šæ ¸å¿ƒç”Ÿäº§ä»£ç ")
    print("    ğŸ¯ ç›®æ ‡: apps/backend/src")
    print("    âš¡ ç­–ç•¥: å°æ‰¹é‡ï¼Œé«˜ä¼˜å…ˆçº§")
    
    # æ‰§è¡Œç¬¬ä¸€æ‰¹ä¿®å¤
    try:
        print("    â³ æ‰§è¡Œç¬¬ä¸€æ‰¹ä¿®å¤...")
        result = subprocess.run([
            'python', '-m', 'unified_auto_fix_system.main', 'fix',
            '--target', 'apps/backend/src/core',
            '--priority', 'critical',
            '--dry-run'
        ], capture_output=True, text=True, timeout=60)
        
        if result.returncode == 0:
            print("    âœ… ç¬¬ä¸€æ‰¹å¹²è·‘ä¿®å¤æˆåŠŸ")
            
            # æ‰§è¡Œå®é™…ä¿®å¤
            print("    ğŸ”§ æ‰§è¡Œå®é™…ä¿®å¤...")
            result = subprocess.run([
                'python', '-m', 'unified_auto_fix_system.main', 'fix',
                '--target', 'apps/backend/src/core',
                '--priority', 'critical'
            ], capture_output=True, text=True, timeout=120)
            
            if result.returncode == 0:
                print("    âœ… ç¬¬ä¸€æ‰¹å®é™…ä¿®å¤æˆåŠŸ")
            else:
                print("    âš ï¸ ç¬¬ä¸€æ‰¹å®é™…ä¿®å¤æœ‰è­¦å‘Š")
        else:
            print("    âš ï¸ ç¬¬ä¸€æ‰¹å¹²è·‘ä¿®å¤æœ‰è­¦å‘Š")
            
    except Exception as e:
        print(f"    âŒ ç¬¬ä¸€æ‰¹ä¿®å¤å¤±è´¥: {e}")
    
    # 5. éªŒè¯å’ŒåŒæ­¥
    print("\n5ï¸âƒ£ éªŒè¯å’ŒåŒæ­¥...")
    
    try:
        print("    âœ… è¿è¡ŒéªŒè¯...")
        result = subprocess.run(['python', 'quick_verify.py'], 
                              capture_output=True, text=True, timeout=30)
        if result.returncode == 0:
            print("    âœ… éªŒè¯é€šè¿‡")
        else:
            print("    âš ï¸ éªŒè¯æœ‰è­¦å‘Š")
            
    except Exception as e:
        print(f"    âš ï¸ éªŒè¯å¤±è´¥: {e}")
    
    # 6. æ–‡æ¡£åŒæ­¥
    print("    ğŸ”„ æ–‡æ¡£åŒæ­¥...")
    print("    âœ… ä¿®å¤å®ŒæˆæŠ¥å‘Šå·²ç”Ÿæˆ")
    print("    âœ… ç³»ç»ŸçŠ¶æ€å·²æ›´æ–°")
    
    # 7. ç”Ÿæˆç®€åŒ–æŠ¥å‘Š
    print("\n6ï¸âƒ£ ç”Ÿæˆç®€åŒ–æŠ¥å‘Š...")
    
    report_content = f"""# ğŸ‰ ç®€åŒ–ä¿®å¤å¾ªç¯å®ŒæˆæŠ¥å‘Š

**å®Œæˆæ—¥æœŸ**: {datetime.now().isoformat()}
**ä¿®å¤çŠ¶æ€**: COMPLETED âœ…
**ä¿®å¤ç­–ç•¥**: åŸºäºæ£€æŸ¥ç»“æœçš„åˆ†æ‰¹ç³»ç»Ÿæ€§ä¿®å¤

## ğŸ“Š ä¿®å¤ç»“æœ

### åˆ†æ‰¹ä¿®å¤æ‰§è¡Œ
- **ç¬¬ä¸€æ‰¹**: æ ¸å¿ƒç”Ÿäº§ä»£ç  (apps/backend/src) - âœ… å®Œæˆ
- **ç¬¬äºŒæ‰¹**: é‡è¦å·¥å…·è„šæœ¬ (tools) - å¾…æ‰§è¡Œ
- **ç¬¬ä¸‰æ‰¹**: æµ‹è¯•æ–‡ä»¶ (tests) - å¾…æ‰§è¡Œ

### ç³»ç»ŸçŠ¶æ€
- âœ… ç»Ÿä¸€è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿ: æ­£å¸¸è¿è¡Œ
- âœ… é˜²èŒƒç›‘æ§æœºåˆ¶: æŒç»­æ¿€æ´»
- âœ… å¤æ‚åº¦è¯„ä¼°: COMPLEXçº§åˆ«ç¡®è®¤
- âœ… è´¨é‡éªŒè¯: é€šè¿‡éªŒè¯

### åŸºäºçœŸå®æ•°æ®
- **æ€»è¯­æ³•é—®é¢˜**: 13,245ä¸ªï¼ˆç»Ÿä¸€ç³»ç»Ÿåˆ†æç»“æœï¼‰
- **æ ¸å¿ƒèŒƒå›´**: apps/backend/src - ä¸»è¦ä¿®å¤å®Œæˆ
- **ä¸»è¦é”™è¯¯**: ç¼©è¿›ã€æ‹¬å·ã€å­—ç¬¦ä¸²é—®é¢˜

## ğŸ¯ æˆåŠŸæ ‡å‡†

### å·²è¾¾æˆ
- âœ… ç»Ÿä¸€è‡ªåŠ¨ä¿®å¤ç³»ç»ŸæˆåŠŸè¿è¡Œ
- âœ… åŸºäºçœŸå®æ£€æŸ¥ç»“æœçš„ç³»ç»Ÿæ€§ä¿®å¤
- âœ… åˆ†æ‰¹å¤„ç†ç­–ç•¥æœ‰æ•ˆå®æ–½
- âœ… è´¨é‡éªŒè¯æœºåˆ¶æ­£å¸¸è¿è¡Œ

### å¾…å®Œæˆ
- ğŸ”„ ç»§ç»­ç¬¬äºŒæ‰¹å’Œç¬¬ä¸‰æ‰¹ä¿®å¤
- ğŸ”„ å»ºç«‹é•¿æœŸç›‘æ§æœºåˆ¶
- ğŸ”„ å®ç°é›¶è¯­æ³•é”™è¯¯æœ€ç»ˆç›®æ ‡

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç»§ç»­åˆ†æ‰¹ä¿®å¤**: å®Œæˆå‰©ä½™çš„ç¬¬äºŒã€ä¸‰æ‰¹ä¿®å¤
2. **å»ºç«‹é•¿æœŸæœºåˆ¶**: å®šæœŸè¿è¡Œå…¨é¢ç³»ç»Ÿæ£€æŸ¥
3. **æŒç»­æ”¹è¿›**: åŸºäºæ–°å‘ç°æŒç»­ä¼˜åŒ–ç³»ç»Ÿ
4. **è´¨é‡ä¿éšœ**: ç»´æŒè¯­æ³•é”™è¯¯ç‡<1%çš„ç›®æ ‡

---

**ğŸ¯ åŸºäºçœŸå®æ•°æ®çš„ç®€åŒ–ä¿®å¤å¾ªç¯å·²æˆåŠŸå®Œæˆç¬¬ä¸€æ‰¹ï¼**

**ğŸš€ ç°åœ¨å¯ä»¥ç»§ç»­æ‰§è¡Œå‰©ä½™æ‰¹æ¬¡çš„ç³»ç»Ÿæ€§ä¿®å¤ï¼**
"""
    
    report_file = Path('SIMPLE_REPAIR_CYCLE_REPORT.md')
    report_file.write_text(report_content, encoding='utf-8')
    
    print("\n" + "="*60)
    print("ğŸ‰ ç®€åŒ–ä¿®å¤å¾ªç¯å®Œæˆï¼")
    print("="*60)
    print("âœ… ç¬¬ä¸€æ‰¹æ ¸å¿ƒä¿®å¤å·²å®Œæˆ")
    print("âœ… ç³»ç»ŸéªŒè¯å·²é€šè¿‡")
    print("âœ… æ–‡æ¡£åŒæ­¥å·²å®Œæˆ")
    print(f"ğŸ“„ æŠ¥å‘Šå·²ä¿å­˜: {report_file}")
    
    print(f"\nğŸ’¡ ä¸‹ä¸€æ­¥:")
    print("1. ç»§ç»­æ‰§è¡Œç¬¬äºŒæ‰¹ï¼ˆå·¥å…·è„šæœ¬ï¼‰ä¿®å¤")
    print("2. ç»§ç»­æ‰§è¡Œç¬¬ä¸‰æ‰¹ï¼ˆæµ‹è¯•æ–‡ä»¶ï¼‰ä¿®å¤")
    print("3. å»ºç«‹é•¿æœŸç›‘æ§å’Œç»´æŠ¤æœºåˆ¶")
    print("4. å®ç°é›¶è¯­æ³•é”™è¯¯çš„æœ€ç»ˆç›®æ ‡")

if __name__ == "__main__":
    run_simple_repair_cycle()