# 测试文件路径冲突问题根本解决计划

## 问题分析

测试文件路径冲突问题的根本原因在于：
1. pytest 配置虽然包含了排除规则，但规则不够完善，未能完全排除所有备份目录
2. 备份目录不断累积，导致即使有排除规则也会出现路径冲突
3. 缺乏自动清理机制，备份目录会无限增长

## 解决方案

### 1. 完善 pytest 配置

已更新项目中的 pytest 配置文件，增强排除规则：

**根目录 pytest.ini 文件更新：**
- 在 `norecursedirs` 中添加了更全面的排除规则
- 在 `ignore` 中增加了针对 apps 目录下备份的排除规则
- 在 `addopts` 中增强了 `--ignore-glob` 参数

**backend 目录 pytest.ini 文件更新：**
- 在 `addopts` 中增加了针对 apps 目录下备份的排除规则

### 2. 创建自动清理脚本

创建了 `scripts/clean_backup_archive.py` 脚本，具有以下功能：
- 自动清理超过7天的旧备份目录
- 限制备份目录数量，只保留最近的10个备份
- 记录清理日志，便于追踪

### 3. 预防措施

#### 3.1 定期执行清理脚本
建议通过 cron job 或 Windows 任务计划程序定期执行清理脚本：

```bash
# 每天凌晨2点执行清理
0 2 * * * python /path/to/project/scripts/clean_backup_archive.py
```

#### 3.2 备份目录命名规范
- 自动备份统一使用 `auto_fix_` 前缀
- 手动备份统一使用 `backup_` 前缀
- 避免在备份目录中保留测试文件

#### 3.3 持续监控
- 定期检查备份目录大小
- 监控 pytest 收集测试的错误日志
- 及时调整排除规则

## 验证方法

1. 运行 `python -m pytest --collect-only -v` 检查是否还有备份目录中的测试被收集
2. 执行 `python scripts/clean_backup_archive.py` 验证清理脚本功能
3. 观察一段时间内是否还有路径冲突问题出现

## 后续改进建议

1. 考虑将备份目录移到项目外部，避免与测试目录混合
2. 实现更智能的备份管理机制，自动归档和清理
3. 建立监控告警机制，当备份目录过多时自动通知