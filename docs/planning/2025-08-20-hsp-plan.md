# HSP Connector 內存派發與 publish_fact 規劃（2025-08-20）

一、背景與目標
- 針對 HSPConnector 的事實（Fact）訊息路徑，確認在 mock mode 與實際 MQTT 下的行為一致性，並確保測試可可靠驗證。

二、目前現況與已確認事項
- HSPConnector.publish_fact：在組裝 HSP Envelope 後，會先將整個封包（envelope）透過 internal_bus 發佈到主題 "hsp.internal.fact"，然後再呼叫 publish_message 送出到 MQTT。
- 測試 test_hsp_simple.py 透過 internal_bus 訂閱 "hsp.internal.fact"，呼叫 publish_fact 後能收到封包，驗證成功。
- Connector 內含多個 _dispatch_* 方法，負責將來自 internal_bus 的封包分發給已註冊的回調（callbacks），並在需要時回送 ACK。
- MessageBridge 會將外部進來的訊息解析並映射至 internal_bus 專用通道（例如 Fact -> hsp.external.fact），以便本機模組/測試訂閱。

三、重要發現（需要修正）與處置結果
- [已於 2025-08-20 完成] CLI 的 handle_publish_fact 先前以「同步」方式呼叫 async 的 publish_fact（未 await）問題，已修正為 async 並正確 await，並新增 --echo/--wait 與 --echo-timeout 以等待 "hsp.internal.fact" 內部回音；詳見 <mcfile name="main.py" path="d:\Projects\Unified-AI-Project\packages\cli\cli\main.py"></mcfile>。

四、決策與下一步（狀態）
1) 優先修正 CLI 發佈路徑的 await 問題，避免誤導性的成功訊息，並讓 CLI 端能與測試與後端一致。 [已完成 2025-08-20]
2) 補上 CLI 發佈事實的端到端測試，驗證：
   - publish_fact 被正確 await；
   - internal_bus 能收到 echo；
   - （如有對等節點）對端能透過 callback 收到。 [已完成 - 新增 tests: packages/cli/tests/test_cli_publish_fact.py]
3) 在 connector 層新增針對 internal_bus『hsp.internal.fact』與 external 對映（例如 hsp.external.fact）的單元測試，避免回歸。 [已完成 - 新增 tests: apps/backend/src/hsp/bridge/test_message_bridge.py]
4) 檢視並穩定測試中的 asyncio.sleep，用事件/條件等待取代，降低不穩定性。 [待辦]

五、風險與注意事項
- 事件迴圈管理：將同步 CLI 流程切到 async 需要確認入口點如何管理事件迴圈（Windows/Posix 差異）。目前 CLI 採用 asyncio.run(main_cli_logic)。
- 測試穩定性：移除裸 sleep 後需要設計合適的等待條件（例如接收隊列、Future 完成）。
- 介面相容性：修正 CLI 後需確認現有腳本與自動化流程不受影響。

六、里程碑
- 今日（2025-08-20）：
  - 已完成：
    - 確認 publish_fact 內部 echo 機制與測試用法；
    - 修正 CLI await 問題，並新增 --echo/--wait、--echo-timeout 與 internal_bus 訂閱等待、逾時與解除訂閱邏輯。
  - 剩餘：
    - 新增 CLI 發佈事實端到端測試；
    - 檢視 _dispatch_* 與 MessageBridge 交互測試覆蓋。
- 明日：
  - 實作 CLI 測試；
+  - （已完成）實作 CLI 測試（packages/cli/tests/test_cli_publish_fact.py）；
   - 補齊 connector 層映射單元測試與條件等待的測試工具。
+   - （已完成）補齊 connector 層映射單元測試（apps/backend/src/hsp/bridge/test_message_bridge.py）與條件等待的測試工具。
- 後續：
  - ServiceDiscovery 測試替身與注入機制；
  - HAMMemoryManager 測試用 in-memory 存儲；
  - DialogueManager 與 TaskResult 狀態轉移完善。

七、驗收標準（DoD）
- [部份達成] CLI 發佈事實可穩定完成，正確等待並印出結果（已在 CLI 互動中驗證，待自動化測試覆蓋）。
- 單元與整合測試涵蓋 internal_bus echo 與 callback 派發（部分達成：已有 CLI 端到端測試；connector 單元測試待補）。
- 單元與整合測試涵蓋 internal_bus echo 與 callback 派發（部分達成：已有 CLI 端到端測試、MessageBridge 單元測試；connector 單元測試待補）。

- 取消任意 sleep 後測試仍穩定（待辦）。
- 相關模組介面（publish_fact 等）在測試與 CLI 下行為一致（持續驗證中）。

八、附錄：d:\Projects\121.txt 摘要與關聯決策（2025-08-20）
- 內容焦點：
  - 模型（Flash/Pro）間文字對話紀錄的「共享」是合理且可行的後續功能；建議以獨立 Dialogue History Service 承接，維持模型計算與紀錄管理解耦合。
  - 專案類型定位：本專案屬於「AGI 優先」設計（多代理、記憶、工具、學習迴路），初始等級與上限相較「應用優先」專案更高，應維持模組化骨架與自我改進路徑。
- 與 HSP/CLI 近期工作的關聯：
  - 為了支撐端到端觀測與可測性（observability/testability），CLI 新增 echo 等待是必要基礎，有助於未來將事實事件串入對話紀錄服務與多代理學習迴路。
- 後續追蹤（非本日範圍）：
  - 設計 Dialogue History Service 介面，與 HSP 事件橋接；
  - 定義最小可行的跨模型文字紀錄共享流程與隱私控制。