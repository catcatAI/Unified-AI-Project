<style>
  .fade-in {
    animation: fadeIn 1s ease-in-out forwards;
  }
  .fade-out {
    animation: fadeOut 1s ease-in-out forwards;
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  @keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
  }
  
  /* Game Feel Animations */
  @keyframes flash-green {
    0% { background-color: rgba(74, 222, 128, 0.3); }
    100% { background-color: transparent; }
  }
  @keyframes flash-red {
    0% { background-color: rgba(248, 113, 113, 0.3); }
    100% { background-color: transparent; }
  }
  .flash-green { animation: flash-green 0.5s ease-out; }
  .flash-red { animation: flash-red 0.5s ease-out; }

  @keyframes pulse-cyan {
    0%, 100% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0); }
    50% { box-shadow: 0 0 0 5px rgba(6, 182, 212, 0.5); }
  }
  @keyframes pulse-red {
    0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    50% { box-shadow: 0 0 0 5px rgba(239, 68, 68, 0.7); }
  }
  .overclock-active {
    animation: pulse-cyan 2s infinite;
  }
  .major-event-active {
    animation: pulse-red 1s infinite;
  }
  
  @keyframes fadeInPanel {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .fade-in-panel {
    animation: fadeInPanel 0.3s ease-out forwards;
  }
  
  @keyframes spin-slow {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  .animate-spin-slow {
    animation: spin-slow 3s linear infinite;
  }
</style>

@if (isGameStarted()) {
  <div class="fade-in">
    <app-major-event-modal [event]="currentMajorEvent()" (dismiss)="onDismissMajorEvent()"></app-major-event-modal>
    <app-m6-review-modal 
        [isVisible]="isM6ReviewVisible()" 
        [m6Security]="coreState().M6_Security.value"
        (confirm)="onConfirmMValueUpgrade()"
        (cancel)="onCancelMValueUpgrade()">
    </app-m6-review-modal>
    <app-game-end-modal [endState]="gameEndState()" (restart)="onRestartGame()"></app-game-end-modal>

    <div class="min-h-screen bg-gray-950/80 text-white flex flex-col relative transition-shadow duration-500"
         [class.overclock-active]="overclock().isActive"
         [class.major-event-active]="currentMajorEvent()">
      <!-- Background noise effect -->
      <div class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-5 pointer-events-none"></div>
      
      <!-- Backdrop for mobile sidebar -->
      @if(isSidebarOpen()) {
        <div (click)="toggleSidebar(false)" class="fixed inset-0 bg-black/60 z-20 md:hidden"></div>
      }

      <!-- Top Resource Bar -->
      <app-resource-bar [resourceState]="resourceState()"></app-resource-bar>

      <main class="flex flex-1 overflow-hidden relative">
        <!-- Left Sidebar: Core Stats -->
        <aside class="absolute inset-y-0 left-0 z-30 w-full max-w-xs transform transition-transform duration-300 ease-in-out md:relative md:w-[420px] md:translate-x-0 p-4 bg-gray-900/80 shadow-2xl border-r border-cyan-700/30 overflow-y-auto backdrop-blur-sm"
               [class]="isSidebarOpen() ? 'translate-x-0' : '-translate-x-full'">
          <app-sidebar 
            [coreState]="coreState()" 
            [resourceState]="resourceState()" 
            [entities]="entities()"
            [activePanel]="activePanel()"
            [detailedEntity]="detailedEntity()"
            [isGeneratingEvent]="isGeneratingEvent()"
            [timedActions]="timedActions()"
            (close)="toggleSidebar(false)"
            (setActivePanel)="onSetActivePanel($event)"
            (showEntityDetails)="onShowEntityDetails($event)"
            (clearEntityDetails)="onClearEntityDetails()"
            (unlockAbility)="onUnlockAbility($event)"
            (buildStructure)="onBuildStructure($event)"
            (requestGeminiEvent)="onRequestGeminiEvent()"
            (requestUpgrade)="requestMValueUpgrade($event)"
            (manifestNewEntity)="onManifestNewEntity($event)"
            (convertForExpansion)="onConvertForExpansion()"
            (expandGrid)="onExpandGrid()">
          </app-sidebar>
        </aside>

        <!-- Main Content: Hex Grid and Actions -->
        <div class="flex-1 flex flex-col p-4 md:p-6 gap-6 overflow-hidden relative z-10">
          <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div class="flex items-center">
                <button (click)="toggleSidebar(true)" class="p-2 mr-3 rounded-lg bg-gray-800/70 hover:bg-cyan-700/80 md:hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
                <div>
                  <h2 class="text-2xl lg:text-3xl font-bold text-cyan-400 flex items-center drop-shadow-lg font-orbitron">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 lg:h-8 lg:w-8 mr-3 text-cyan-500 hidden sm:block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" /></svg>
                      {{ 'app.gridControlTitle' | translate }}
                  </h2>
                  <p class="text-xs sm:text-sm text-gray-400 mt-1">{{ 'app.gridControlSubtitle' | translate }}</p>
                </div>
            </div>
            <div class="flex items-center bg-gray-900/50 border border-cyan-400/20 p-1 rounded-lg shadow-md self-end sm:self-center">
                <button (click)="onSetGameSpeed(0)" title="Pause Game" class="px-3 py-1.5 rounded-md transition-colors" [class]="gameSpeed() === 0 ? 'bg-red-600 text-white shadow-lg' : 'hover:bg-gray-700 text-gray-300'">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                </button>
                <button (click)="onSetGameSpeed(1)" class="px-3 py-1.5 rounded-md transition-colors font-bold" [class]="gameSpeed() === 1 ? 'bg-cyan-600 text-white shadow-lg' : 'hover:bg-gray-700 text-gray-300'">1x</button>
                <button (click)="onSetGameSpeed(2)" class="px-3 py-1.5 rounded-md transition-colors font-bold" [class]="gameSpeed() === 2 ? 'bg-cyan-600 text-white shadow-lg' : 'hover:bg-gray-700 text-gray-300'">2x</button>
                <button (click)="onSetGameSpeed(3)" class="px-3 py-1.5 rounded-md transition-colors font-bold" [class]="gameSpeed() === 3 ? 'bg-cyan-600 text-white shadow-lg' : 'hover:bg-gray-700 text-gray-300'">3x</button>
            </div>
          </header>

          <div class="flex-1 flex flex-col lg:flex-row gap-6 overflow-hidden">
            <!-- Hex Grid Viewport -->
            <div 
              class="flex-1 h-full bg-black/20 rounded-2xl p-4 border border-cyan-600/20 shadow-inner shadow-cyan-900/50 relative overflow-hidden min-h-[300px]"
              (mousedown)="onPanStart($event)"
              (touchstart)="onPanStart($event)"
              [class.cursor-grabbing]="isPanning()"
              [class.cursor-grab]="!isPanning()">
               <div class="absolute inset-0" style="background-image: radial-gradient(ellipse at center, rgba(3, 7, 18, 0) 0%, #030712 75%);"></div>
               <div class="absolute top-2 left-4 text-xs uppercase text-cyan-500 font-orbitron tracking-widest z-10">Structure Viewport</div>
               
               <!-- Map Controls -->
               <div class="absolute top-2 right-4 z-20 flex flex-col space-y-1">
                  <button (click)="zoomIn()" class="p-1.5 bg-gray-800/70 hover:bg-cyan-700/80 rounded-full border border-cyan-400/20 text-cyan-300 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg></button>
                  <button (click)="zoomOut()" class="p-1.5 bg-gray-800/70 hover:bg-cyan-700/80 rounded-full border border-cyan-400/20 text-cyan-300 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg></button>
                  <button (click)="resetView()" class="p-1.5 bg-gray-800/70 hover:bg-cyan-700/80 rounded-full border border-cyan-400/20 text-cyan-300 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H6zM6 5a1 1 0 100 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg></button>
               </div>
               
               <div class="w-full h-full transition-transform duration-100 ease-linear" [style.transform]="mapTransform()">
                 <app-hex-grid [mapData]="mapData()" [selectedHex]="selectedHex()" (hexSelected)="onHexSelected($event)"></app-hex-grid>
               </div>
            </div>
            <!-- Contextual Action Panel -->
            <div class="w-full lg:w-1/3 lg:max-w-sm h-auto lg:h-full">
                <app-action-panel 
                  [selectedHex]="selectedHex()" 
                  [coreState]="coreState()" 
                  [resourceState]="resourceState()"
                  [entities]="entities()"
                  [overclock]="overclock()"
                  (setActivePanel)="onSetActivePanel($event)"
                  (dispatchEntity)="onDispatchEntity($event)"
                  (recallEntity)="onRecallEntity($event)"
                  (initiateExtraction)="onInitiateExtraction($event)"
                  (initiateConversion)="onInitiateConversion($event)"
                  (scoutHex)="onScoutHex($event)"
                  (activateCoreOverclock)="onActivateCoreOverclock()">
                </app-action-panel>
            </div>
          </div>
          <!-- Event Log -->
          <div class="h-40 md:h-56">
              <app-event-log [events]="events()"></app-event-log>
          </div>
        </div>
      </main>
    </div>
  </div>
} @else {
  <div class="min-h-screen flex items-center justify-center text-center p-4 fade-in">
    <div>
      <h1 class="text-4xl sm:text-6xl lg:text-8xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500 drop-shadow-lg font-orbitron">
        {{ 'app.title' | translate }}
      </h1>
      <p class="text-lg md:text-xl text-cyan-200 mt-2 font-orbitron tracking-wider">{{ 'app.subtitle' | translate }}</p>
      <button (click)="startGame()"
        class="mt-12 px-12 py-4 bg-cyan-600 text-white font-bold text-lg rounded-lg shadow-lg shadow-cyan-500/20
               hover:bg-cyan-500 hover:shadow-cyan-400/30
               transition-all duration-300 animate-pulse hover:animate-none">
        {{ 'app.startButton' | translate }}
      </button>
    </div>
  </div>
}
