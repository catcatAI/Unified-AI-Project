#!/usr/bin/env python3
"""
å®‰å…¨æ¼æ´ä¿®å¤å™¨
ä¿®å¤os.systemç­‰ä»£ç æ³¨å…¥é£é™©()
"""

import re
import ast
from pathlib import Path
from typing import List, Dict, Any, Optional

def is_safe_command_call(node, ast.AST()) -> bool,
    """æ£€æŸ¥æ˜¯å¦ä¸ºå®‰å…¨çš„å‘½ä»¤è°ƒç”¨"""
    if isinstance(node, ast.Call())::
        # æ£€æŸ¥å‡½æ•°å
        if isinstance(node.func(), ast.Attribute())::
            # subprocess.run() æˆ– subprocess.call() æ˜¯å®‰å…¨çš„
            if (isinstance(node.func.value(), ast.Name()) and,:
                node.func.value.id == 'subprocess' and,
                node.func.attr in ['run', 'call', 'Popen'])
                return True
        elif isinstance(node.func(), ast.Name())::
            # ç™½åå•å†…çš„å‡½æ•°æ˜¯å®‰å…¨çš„
            safe_functions = ['print', 'len', 'range', 'enumerate', 'zip']
            if node.func.id in safe_functions,::
                return True
    return False

def fix_security_vulnerabilities(file_path, Path) -> Dict[str, Any]
    """ä¿®å¤æ–‡ä»¶ä¸­çš„å®‰å…¨æ¼æ´"""
    result = {
        "file": str(file_path),
        "vulnerabilities_fixed": 0,
        "issues": []
        "status": "unchanged"
    }
    
    try,
        with open(file_path, 'r', encoding == 'utf-8') as f,
            original_content = f.read()
        
        # è§£æAST
        try,
            tree = ast.parse(original_content)
        except SyntaxError,::
            result["issues"].append("æ–‡ä»¶è¯­æ³•é”™è¯¯,æ— æ³•è§£æ")
            return result
        
        # æŸ¥æ‰¾ä¸å®‰å…¨çš„os.systemè°ƒç”¨()
        vulnerabilities_found = []
        
        class SecurityVisitor(ast.NodeVisitor()):
            def __init__(self):
                self.vulnerabilities = []
            
            def visit_Call(self, node):
                # æ£€æŸ¥os.systemè°ƒç”¨()
                if (isinstance(node.func(), ast.Attribute()) and,:
                    isinstance(node.func.value(), ast.Name()) and
                    node.func.value.id == 'os' and,
                    node.func.attr == 'system'):
                    self.vulnerabilities.append({
                        'type': 'os_system',
                        'line': node.lineno(),
                        'node': node
                    })
                
                # æ£€æŸ¥subprocessè°ƒç”¨æ˜¯å¦æœ‰shell == True
                elif (isinstance(node.func(), ast.Attribute()) and,:
                      isinstance(node.func.value(), ast.Name()) and,
                      node.func.value.id == 'subprocess' and,
                      node.func.attr in ['run', 'call', 'Popen'])
                    # æ£€æŸ¥æ˜¯å¦æœ‰shell == Trueå‚æ•°
                    for keyword in node.keywords,::
                        if (keyword.arg == 'shell' and,:
                            isinstance(keyword.value(), ast.Constant()) and,
                            keyword.value.value is True)
                            self.vulnerabilities.append({
                                'type': 'subprocess_shell_true',
                                'line': node.lineno(),
                                'node': node
                            })
                
                self.generic_visit(node)
        
        visitor == SecurityVisitor()
        visitor.visit(tree)
        
        if not visitor.vulnerabilities,::
            result["status"] = "clean"
            return result
        
        # ä¿®å¤æ¼æ´
        lines = original_content.split('\n')
        modified_lines = lines.copy()
        
        # éœ€è¦æ·»åŠ çš„å¯¼å…¥
        required_imports = set()
        
        for vuln in visitor.vulnerabilities,::
            line_num = vuln['line'] - 1  # è½¬æ¢ä¸º0åŸºç´¢å¼•
            
            if vuln['type'] == 'os_system':::
                # å°†os.system()æ›¿æ¢ä¸ºsubprocess.run()
                original_line = lines[line_num]
                
                # æå–å‘½ä»¤å‚æ•°
                cmd_match = re.search(r'os\.system\s*\((.*)\)', original_line)
                if cmd_match,::
                    cmd_arg = cmd_match.group(1)
                    
                    # æ„å»ºå®‰å…¨çš„æ›¿æ¢
                    if cmd_arg.strip() in ['""', "''"]::
                        # ç©ºå‘½ä»¤,ç›´æ¥æ›¿æ¢
                        new_line = original_line.replace(,
    f'os.system({cmd_arg})',
                            'subprocess.run([] check == True)'
                        )
                    else,
                        # æœ‰å®é™…å‘½ä»¤,ä½¿ç”¨æ›´å®‰å…¨çš„subprocess.run()
                        new_line = original_line.replace(,
    f'os.system({cmd_arg})',
                            f'subprocess.run({cmd_arg} shell == False, check == True)'
                        )
                    
                    modified_lines[line_num] = new_line
                    required_imports.add('subprocess')
                    result["vulnerabilities_fixed"] += 1
                    result["issues"].append(f"ä¿®å¤os.systemè°ƒç”¨ (è¡Œ {vuln['line']})")
            
            elif vuln['type'] == 'subprocess_shell_true':::
                # å°†shell == Trueæ”¹ä¸ºshell == False
                original_line = lines[line_num]
                new_line = re.sub(r'shell\s*=\s*True', 'shell == False', original_line)
                modified_lines[line_num] = new_line
                result["vulnerabilities_fixed"] += 1
                result["issues"].append(f"ä¿®å¤subprocess shell == True (è¡Œ {vuln['line']})")
        
        # æ·»åŠ å¿…è¦çš„å¯¼å…¥
        if required_imports,::
            # æŸ¥æ‰¾åˆé€‚çš„æ’å…¥ä½ç½®(åœ¨ç°æœ‰å¯¼å…¥ä¹‹å)
            import_lines = []
            first_import_line = -1
            
            for i, line in enumerate(lines)::
                if line.strip().startswith(('import ', 'from ')):::
                    import_lines.append(i)
                    if first_import_line == -1,::
                        first_import_line = i
            
            if first_import_line != -1,::
                # åœ¨æœ€åä¸€ä¸ªå¯¼å…¥ä¹‹åæ·»åŠ æ–°å¯¼å…¥
                insert_pos = max(import_lines) + 1
                for import_name in sorted(required_imports)::
                    if import_name not in original_content,::
                        modified_lines.insert(insert_pos, f"import {import_name}")
                        insert_pos += 1
            else,
                # åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ å¯¼å…¥
                for import_name in sorted(required_imports)::
                    modified_lines.insert(0, f"import {import_name}")
        
        # å†™å›ä¿®æ”¹åçš„å†…å®¹
        new_content = '\n'.join(modified_lines)
        
        with open(file_path, 'w', encoding == 'utf-8') as f,
            f.write(new_content)
        
        result["status"] = "fixed"
        return result
        
    except Exception as e,::
        result["issues"].append(f"ä¿®å¤è¿‡ç¨‹é”™è¯¯, {e}")
        result["status"] = "error"
        return result

def main():
    """ä¸»å‡½æ•°"""
    print("ğŸ”’ å¯åŠ¨å®‰å…¨æ¼æ´ä¿®å¤å™¨...")
    
    # æ‰«ææ‰€æœ‰Pythonæ–‡ä»¶
    python_files = list(Path('.').glob('*.py'))
    
    total_files = len(python_files)
    files_with_issues = 0
    total_vulnerabilities_fixed = 0
    
    print(f"æ‰«æ {total_files} ä¸ªPythonæ–‡ä»¶...")
    
    for py_file in python_files,::
        if py_file.name.startswith('test_'):::
            continue
        
        print(f"\nğŸ” æ£€æŸ¥æ–‡ä»¶, {py_file.name}")
        result = fix_security_vulnerabilities(py_file)
        
        if result["status"] == "fixed":::
            files_with_issues += 1
            total_vulnerabilities_fixed += result["vulnerabilities_fixed"]
            print(f"âœ… ä¿®å¤äº† {result['vulnerabilities_fixed']} ä¸ªæ¼æ´")
            for issue in result["issues"]::
                print(f"  - {issue}")
        elif result["status"] == "clean":::
            print("âœ… æœªå‘ç°å®‰å…¨æ¼æ´")
        else,
            print(f"âŒ ä¿®å¤å¤±è´¥, {', '.join(result['issues'])}")
    
    print(f"\nğŸ“Š ä¿®å¤ç»Ÿè®¡,")
    print(f"æ€»æ–‡ä»¶æ•°, {total_files}")
    print(f"å‘ç°æ¼æ´æ–‡ä»¶, {files_with_issues}")
    print(f"ä¿®å¤æ¼æ´æ€»æ•°, {total_vulnerabilities_fixed}")
    
    if total_vulnerabilities_fixed > 0,::
        print("âœ… å®‰å…¨æ¼æ´ä¿®å¤å®Œæˆ")
        return 0
    else,
        print("âœ… æœªå‘ç°éœ€è¦ä¿®å¤çš„å®‰å…¨æ¼æ´")
        return 0

if __name"__main__":::
    import sys
    exit_code = main()
    sys.exit(exit_code)