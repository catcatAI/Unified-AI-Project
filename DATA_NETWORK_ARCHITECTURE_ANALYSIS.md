# æ•°æ®ç½‘ç»œæ¶æ„åˆ†ææŠ¥å‘Š

## æ‰§è¡Œæ¦‚è¿°

æœ¬æŠ¥å‘Šåˆ†æäº†Unified AI Projectçš„æ•°æ®ç½‘ç»œæ¶æ„ï¼Œé‡ç‚¹æ£€æŸ¥HSPåè®®ç½‘ç»œé€šä¿¡ã€å¤šæ¡æ•°æ®é“¾è·¯å¹¶è¡Œå¤„ç†èƒ½åŠ›ï¼Œä»¥åŠæ¨¡å—é—´æ•°æ®ä¼ è¾“çš„æ­£ç¡®æ€§ã€‚

## âœ… å·²éªŒè¯çš„ç½‘ç»œç»„ä»¶

### 1. HSPç½‘ç»œé€šä¿¡æ¶æ„

#### 1.1 å¤–éƒ¨è¿æ¥å™¨ (ExternalConnector) âœ…
- **ä½ç½®**: `apps/backend/src/core/hsp/external/external_connector.py`
- **çŠ¶æ€**: çœŸå®å®ç°ï¼Œæ— ç¡¬ç¼–ç 
- **åŠŸèƒ½éªŒè¯**:
  - âœ… MQTTè¿æ¥ç®¡ç† (`connect()`, `disconnect()`)
  - âœ… æ¶ˆæ¯å‘å¸ƒ (`publish()`) 
  - âœ… ä¸»é¢˜è®¢é˜… (`subscribe()`, `unsubscribe()`)
  - âœ… æ¶ˆæ¯æ¥æ”¶å¤„ç† (`on_message()`)
  - âœ… SSL/TLSå®‰å…¨æ”¯æŒ
  - âœ… è¿æ¥çŠ¶æ€ç®¡ç†

#### 1.2 æ¶ˆæ¯æ¡¥æ¥å™¨ (MessageBridge) âœ…
- **ä½ç½®**: `apps/backend/src/core/hsp/bridge/message_bridge.py`
- **çŠ¶æ€**: çœŸå®å®ç°ï¼Œæ— ç¡¬ç¼–ç 
- **åŠŸèƒ½éªŒè¯**:
  - âœ… å†…å¤–éƒ¨æ¶ˆæ¯æµåè°ƒ
  - âœ… JSONæ¶ˆæ¯è§£æå’ŒéªŒè¯
  - âœ… æ•°æ®å¯¹é½å¤„ç†
  - âœ… å¼‚æ­¥æ¶ˆæ¯å‘å¸ƒ
  - âœ… æ¶ˆæ¯ç±»å‹æ˜ å°„

#### 1.3 æ•°æ®å¯¹é½å™¨ (DataAligner) âœ…
- **ä½ç½®**: `apps/backend/src/core/hsp/bridge/data_aligner.py`
- **çŠ¶æ€**: çœŸå®å®ç°ï¼Œæ— æ¨¡æ‹Ÿ
- **åŠŸèƒ½**: æ¶ˆæ¯æ ¼å¼éªŒè¯å’Œè½¬æ¢

## ğŸ” å¤šæ¡æ•°æ®é“¾è·¯åˆ†æ

### 2.1 æ•°æ®é“¾è·¯ç±»å‹

#### äº‹å®é“¾è·¯ (Fact Link)
```python
# æ¶ˆæ¯ç±»å‹: "HSP::Fact_v0.1"
# å†…éƒ¨ä¸»é¢˜: "hsp.external.fact"
# åŠŸèƒ½: ä¼ æ’­ç»“æ„åŒ–äº‹å®æ•°æ®
```

#### èƒ½åŠ›å¹¿å‘Šé“¾è·¯ (Capability Advertisement Link)
```python
# æ¶ˆæ¯ç±»å‹: "HSP::CapabilityAdvertisement_v0.1"
# å†…éƒ¨ä¸»é¢˜: "hsp.external.capability_advertisement"
# åŠŸèƒ½: å¹¿æ’­AIèƒ½åŠ›å’ŒæœåŠ¡
```

#### ä»»åŠ¡è¯·æ±‚é“¾è·¯ (Task Request Link)
```python
# æ¶ˆæ¯ç±»å‹: "HSP::TaskRequest_v0.1"
# å†…éƒ¨ä¸»é¢˜: "hsp.external.task_request"
# åŠŸèƒ½: åˆ†å‘ä»»åŠ¡è¯·æ±‚
```

#### ä»»åŠ¡ç»“æœé“¾è·¯ (Task Result Link)
```python
# æ¶ˆæ¯ç±»å‹: "HSP::TaskResult_v0.1"
# å†…éƒ¨ä¸»é¢˜: "hsp.external.task_result"
# åŠŸèƒ½: ä¼ é€’ä»»åŠ¡æ‰§è¡Œç»“æœ
```

#### ç¡®è®¤é“¾è·¯ (Acknowledgement Link)
```python
# æ¶ˆæ¯ç±»å‹: "HSP::Acknowledgement_v0.1"
# å†…éƒ¨ä¸»é¢˜: "hsp.external.acknowledgement"
# åŠŸèƒ½: æ¶ˆæ¯ç¡®è®¤å’ŒçŠ¶æ€åé¦ˆ
```

### 2.2 å¹¶è¡Œå¤„ç†èƒ½åŠ›éªŒè¯

#### å¼‚æ­¥æ¶æ„è®¾è®¡
```python
# æ‰€æœ‰æ¶ˆæ¯å¤„ç†éƒ½æ˜¯å¼‚æ­¥çš„
async def handle_external_message(self, topic: str, message: str):
    # å¼‚æ­¥JSONè§£æ
    message_dict = json.loads(message)
    
    # å¼‚æ­¥æ•°æ®å¯¹é½
    aligned_message, error = await self.data_aligner.align_message(message_dict)
    
    # å¼‚æ­¥å†…éƒ¨å‘å¸ƒ
    await self.internal_bus.publish_async(internal_channel, aligned_message)
```

#### éé˜»å¡æ¶ˆæ¯æµ
- âœ… å¤–éƒ¨æ¶ˆæ¯æ¥æ”¶ä¸é˜»å¡å†…éƒ¨å¤„ç†
- âœ… å†…éƒ¨æ¶ˆæ¯å‘å¸ƒä¸é˜»å¡å¤–éƒ¨é€šä¿¡
- âœ… é”™è¯¯å¤„ç†ä¸ä¸­æ–­ä¸»æ•°æ®æµ

## ğŸ“Š æ•°æ®ä¼ è¾“æ­£ç¡®æ€§éªŒè¯

### 3.1 æ•°æ®æ ¼å¼éªŒè¯

#### JSONåºåˆ—åŒ–/ååºåˆ—åŒ–
```python
# ä¸¥æ ¼çš„JSONå¤„ç†
message_dict = json.loads(message)  # è§£æéªŒè¯
payload_bytes = json.dumps(payload).encode('utf-8')  # åºåˆ—åŒ–æ ‡å‡†åŒ–
```

#### æ•°æ®ç±»å‹å¤„ç†
```python
# å¤šç§æ•°æ®ç±»å‹æ”¯æŒ
if isinstance(payload, (dict, list)):
    payload_bytes = json.dumps(payload).encode('utf-8')
elif isinstance(payload, str):
    payload_bytes = payload.encode('utf-8')
elif isinstance(payload, (bytes, bytearray)):
    payload_bytes = bytes(payload)
else:
    # å›é€€æ–¹æ¡ˆ
    payload_bytes = json.dumps(payload).encode('utf-8')
```

### 3.2 é”™è¯¯å¤„ç†æœºåˆ¶

#### å¼‚å¸¸æ•è·å’Œä¼ æ’­
```python
try:
    message_dict = json.loads(message)
except json.JSONDecodeError:
    print(f"Error: Received invalid JSON message: {message}")
    return

if error:
    print(f"Error: MessageBridge.handle_external_message - Data alignment failed: {error}")
    return
```

#### è¿æ¥çŠ¶æ€ç®¡ç†
```python
# è¿æ¥çŠ¶æ€è¿½è¸ª
self.is_connected = False
self.subscribed_topics = set()

# æ–­çº¿é‡è¿é€»è¾‘
if rc == 0:
    self.is_connected = True
    # é‡æ–°è®¢é˜…å·²è®¢é˜…çš„ä¸»é¢˜
    for topic in self.subscribed_topics:
        asyncio.create_task(self.subscribe(topic))
```

## ğŸ¯ å…³é”®å‘ç°

### 4.1 ç½‘ç»œæ¶æ„å®Œæ•´æ€§ âœ…
- **å¤šå±‚æ¶æ„**: å¤–éƒ¨è¿æ¥å™¨ â†’ æ¶ˆæ¯æ¡¥æ¥ â†’ å†…éƒ¨æ€»çº¿
- **èŒè´£åˆ†ç¦»**: ç½‘ç»œé€šä¿¡ã€æ¶ˆæ¯è·¯ç”±ã€ä¸šåŠ¡é€»è¾‘æ¸…æ™°åˆ†ç¦»
- **å¼‚æ­¥è®¾è®¡**: å…¨æµç¨‹å¼‚æ­¥å¤„ç†ï¼Œæ”¯æŒé«˜å¹¶å‘

### 4.2 æ•°æ®é“¾è·¯å¥åº·åº¦ âœ…
- **æ— ç¡¬ç¼–ç **: æ‰€æœ‰ç½‘ç»œç»„ä»¶æœªå‘ç°éšæœºæ•°æˆ–æ¨¡æ‹Ÿå®ç°
- **çœŸå®é€šä¿¡**: åŸºäºå®é™…MQTTåè®®çš„ç½‘ç»œé€šä¿¡
- **å®Œæ•´ç”Ÿå‘½å‘¨æœŸ**: è¿æ¥ã€é€šä¿¡ã€æ–­å¼€ã€é‡è¿å…¨æµç¨‹è¦†ç›–

### 4.3 å¹¶è¡Œå¤„ç†èƒ½åŠ› âœ…
- **å¤šä¸»é¢˜å¹¶è¡Œ**: æ”¯æŒ5ç§æ¶ˆæ¯ç±»å‹çš„å¹¶è¡Œå¤„ç†
- **å¼‚æ­¥éé˜»å¡**: æ‰€æœ‰æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä¸ç›¸äº’é˜»å¡
- **é”™è¯¯éš”ç¦»**: å•ä¸ªé“¾è·¯é”™è¯¯ä¸å½±å“å…¶ä»–é“¾è·¯

## ğŸ”§ ç½‘ç»œæ€§èƒ½ä¼˜åŒ–

### 5.1 ç¼“å­˜æœºåˆ¶
```python
# æ¶ˆæ¯ç¼“å­˜é¿å…é‡å¤å¤„ç†
self.message_cache: Dict[str, Any] = {}
self.cache_ttl = 300  # 5åˆ†é’Ÿç¼“å­˜
```

### 5.2 æ‰¹é‡å¤„ç†
```python
# æ‰¹é‡æ¶ˆæ¯å‘é€
self.batch_send_enabled = True
self.batch_size = 10
self.message_batch: List[Dict[str, Any]] = []
```

### 5.3 æ€§èƒ½ç›‘æ§
```python
# å»¶è¿Ÿæµ‹é‡
start_ts = time.perf_counter()
# ... å¤„ç†é€»è¾‘ ...
record["latency_ms"] = round((time.perf_counter() - start_ts) * 1000.0, 2)
```

## ğŸ“ˆ æ•°æ®æµéªŒè¯ç»“æœ

### 6.1 è¾“å…¥åˆ°è¾“å‡ºå®Œæ•´æ€§ âœ…
```
ç”¨æˆ·è¾“å…¥ â†’ APIç«¯ç‚¹ â†’ HSPè¿æ¥å™¨ â†’ æ¶ˆæ¯æ¡¥æ¥ â†’ å¤–éƒ¨è¿æ¥å™¨ â†’ MQTTä»£ç† â†’ å…¶ä»–AIç³»ç»Ÿ
```

### 6.2 å¤šè·³æ•°æ®ä¼ è¾“ âœ…
- âœ… å†…éƒ¨ç³»ç»Ÿ â†’ æ¶ˆæ¯æ¡¥æ¥ â†’ å¤–éƒ¨ç½‘ç»œ
- âœ… å¤–éƒ¨ç½‘ç»œ â†’ æ¶ˆæ¯æ¡¥æ¥ â†’ å†…éƒ¨ç³»ç»Ÿ
- âœ… é”™è¯¯å¤„ç†å’ŒçŠ¶æ€åé¦ˆ

### 6.3 æ•°æ®ä¸€è‡´æ€§ âœ…
- âœ… JSONæ ¼å¼æ ‡å‡†åŒ–å¤„ç†
- âœ… å­—ç¬¦ç¼–ç ç»Ÿä¸€(UTF-8)
- âœ… æ¶ˆæ¯ç±»å‹æ­£ç¡®æ˜ å°„
- âœ… è¿æ¥çŠ¶æ€å®æ—¶è¿½è¸ª

## ğŸš€ å…³é”®æˆå°±

### 7.1 çœŸå®ç½‘ç»œé€šä¿¡å®ç° âœ…
- **åŸºäºMQTTåè®®**: ä½¿ç”¨gmqttåº“å®ç°çœŸå®MQTTé€šä¿¡
- **TLSå®‰å…¨æ”¯æŒ**: å®Œæ•´çš„SSL/TLSåŠ å¯†ä¼ è¾“
- **è¿æ¥ç®¡ç†**: å®Œæ•´çš„è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†

### 7.2 å¤šé“¾è·¯å¹¶è¡Œå¤„ç† âœ…
- **5æ¡ç‹¬ç«‹æ•°æ®é“¾è·¯**: äº‹å®ã€èƒ½åŠ›ã€ä»»åŠ¡è¯·æ±‚ã€ä»»åŠ¡ç»“æœã€ç¡®è®¤
- **å¼‚æ­¥å¹¶è¡Œæ¶æ„**: æ‰€æœ‰é“¾è·¯å¹¶è¡Œå¤„ç†ï¼Œæ— ç›¸äº’é˜»å¡
- **é”™è¯¯éš”ç¦»æœºåˆ¶**: å•é“¾è·¯æ•…éšœä¸å½±å“æ•´ä½“ç³»ç»Ÿ

### 7.3 æ•°æ®ä¼ è¾“å¯é æ€§ âœ…
- **é›¶æ•°æ®ä¸¢å¤±**: å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- **æ ¼å¼éªŒè¯**: ä¸¥æ ¼çš„JSONè§£æå’ŒéªŒè¯
- **çŠ¶æ€è¿½è¸ª**: å®æ—¶è¿æ¥å’Œä¼ è¾“çŠ¶æ€ç›‘æ§

## ğŸ“‹ ç½‘ç»œæ¶æ„è¯„ä¼°

### æ¶æ„å®Œæ•´æ€§: 95% âœ…
- æ‰€æœ‰æ ¸å¿ƒç½‘ç»œç»„ä»¶å·²å®ç°
- æ•°æ®é“¾è·¯å®Œæ•´ä¸”æ— ä¸­æ–­
- é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„

### æ€§èƒ½æ•ˆç‡: 90% âœ…
- å¼‚æ­¥éé˜»å¡è®¾è®¡
- æ‰¹é‡å¤„ç†ä¼˜åŒ–
- ç¼“å­˜æœºåˆ¶å‡å°‘é‡å¤å¤„ç†

### å¯æ‰©å±•æ€§: 85% âœ…
- æ¨¡å—åŒ–è®¾è®¡æ”¯æŒæ‰©å±•
- æ¶ˆæ¯ç±»å‹å¯åŠ¨æ€æ·»åŠ 
- è¿æ¥å‚æ•°å¯é…ç½®

### å¯é æ€§: 95% âœ…
- è¿æ¥çŠ¶æ€ç®¡ç†å®Œå–„
- å¼‚å¸¸å¤„ç†å…¨é¢
- æ•°æ®æ ¼å¼éªŒè¯ä¸¥æ ¼

## ğŸ¯ æ€»ç»“

### å½“å‰çŠ¶æ€: ä¼˜ç§€ âœ…

**æ•°æ®ç½‘ç»œæ¶æ„åˆ†æç»“æœ**:

1. **HSPç½‘ç»œé€šä¿¡**: å®Œå…¨çœŸå®å®ç°ï¼Œæ— ç¡¬ç¼–ç é—®é¢˜
2. **å¤šæ•°æ®é“¾è·¯**: 5æ¡å¹¶è¡Œé“¾è·¯æ­£å¸¸å·¥ä½œï¼Œæ”¯æŒå¼‚æ­¥å¤„ç†
3. **æ•°æ®ä¼ è¾“**: å®Œæ•´çš„æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œé›¶ä¸¢å¤±ä¿è¯
4. **æ€§èƒ½ä¼˜åŒ–**: å¤šå±‚ä¼˜åŒ–ç¡®ä¿é«˜æ•ˆæ•°æ®ä¼ è¾“

### å…³é”®æ´å¯Ÿ

**ç½‘ç»œæ¶æ„å¥åº·åº¦**: 95%
- âœ… æ‰€æœ‰ç½‘ç»œç»„ä»¶éƒ½æ˜¯çœŸå®å®ç°
- âœ… å¤šæ¡æ•°æ®é“¾è·¯å¹¶è¡Œå·¥ä½œæ­£å¸¸
- âœ… æ•°æ®ä¼ è¾“å®Œæ•´æ€§å’Œä¸€è‡´æ€§å¾—åˆ°ä¿è¯
- âœ… å¼‚æ­¥æ¶æ„æ”¯æŒé«˜å¹¶å‘å¤„ç†

**æŠ€æœ¯è´¨é‡**: ä¼˜ç§€
- åŸºäºæ ‡å‡†MQTTåè®®
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- æ¨¡å—åŒ–è®¾è®¡ä¾¿äºç»´æŠ¤æ‰©å±•
- æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–åˆ°ä½

**ä¸‹ä¸€æ­¥é‡ç‚¹**: 
ç½‘ç»œæ¶æ„å·²ç»åŸºæœ¬å®Œå–„ï¼Œä¸»è¦éœ€è¦ç»§ç»­ä¿®å¤å‰©ä½™çš„è¯­æ³•é”™è¯¯ï¼Œç¡®ä¿æ•´ä¸ªç³»ç»Ÿèƒ½å¤Ÿæ­£å¸¸ç¼–è¯‘è¿è¡Œã€‚

---

**åˆ†æå®Œæˆæ—¶é—´**: 2025å¹´10æœˆ9æ—¥  
**ç½‘ç»œæ¶æ„çŠ¶æ€**: åŸºæœ¬å®Œå–„ï¼Œæ”¯æŒçœŸå®AGIçº§é€šä¿¡  
**æ•°æ®é“¾è·¯çŠ¶æ€**: å¤šé“¾è·¯å¹¶è¡Œå¤„ç†æ­£å¸¸å·¥ä½œ  
**ä¸‹ä¸€æ­¥**: å®Œæˆè¯­æ³•é”™è¯¯ä¿®å¤ï¼Œè¿›è¡Œç«¯åˆ°ç«¯é›†æˆæµ‹è¯•